openapi: 3.0.3
info:
  title: AI规则生成和JEXL校验API
  description: |
    基于大语言模型的JEXL规则自动生成API，支持发票校验和补全规则的智能生成，以及独立的JEXL语法校验功能。
    
    ## 功能特性
    - 支持自然语言描述自动生成JEXL规则
    - 独立的JEXL语法校验功能
    - 自动语法校验和错误修复
    - 支持数据库函数调用 (db命名空间)
    - 可选择保存规则到数据库
    
    ## 模型配置
    - 默认模型：gpt-5-mini
    - 支持DeepSeek等OpenAI兼容模型
    - 通过配置文件或环境变量配置API密钥
  version: "1.0.0"
  contact:
    name: API Support
    email: support@kingdee.com

servers:
  - url: http://localhost:8081
    description: 本地开发服务器
  - url: https://api.example.com
    description: 生产环境

paths:
  /api/ai/rules/jexl/validate:
    post:
      tags:
        - JEXL校验
      summary: JEXL语法校验
      description: |
        对单个JEXL表达式进行语法校验，检查语法是否正确。
        
        ## 校验功能
        - 编译检查JEXL表达式语法
        - 返回详细的错误信息
        - 支持任何有效的JEXL语法
        
        ## 使用场景
        - 规则编写前的语法检查
        - 表达式调试和验证
        - 集成到规则编辑器中
      operationId: validateJexl
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: JEXL语法校验请求
              properties:
                expression:
                  type: string
                  description: |
                    待校验的JEXL表达式，必填。
                    支持任何有效的JEXL语法，如算术运算、逻辑判断、方法调用等。
                  example: "invoice != null && invoice.totalAmount.doubleValue() > 0"
              required:
                - expression
            examples:
              valid_expression:
                summary: 有效的JEXL表达式
                value:
                  expression: "invoice != null && invoice.totalAmount.doubleValue() > 0"
              invalid_expression:
                summary: 无效的JEXL表达式
                value:
                  expression: "invoice.totalAmount +"
      responses:
        '200':
          description: 校验完成
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Result'
                  - type: object
                    properties:
                      data:
                        type: object
                        description: JEXL语法校验响应
                        properties:
                          valid:
                            type: boolean
                            description: 校验是否通过，true表示语法正确
                            example: true
                          errors:
                            type: array
                            description: 校验错误列表，校验通过时为空数组
                            items:
                              type: object
                              description: 校验错误详情
                              properties:
                                field:
                                  type: string
                                  description: 出错的字段名称（对于单表达式校验，固定为"expression"）
                                  enum: ["expression"]
                                  example: "expression"
                                message:
                                  type: string
                                  description: 错误描述信息
                                  example: "Parse error at index 19: expected operand"
                            example: []
              examples:
                valid_result:
                  summary: 校验通过
                  value:
                    errcode: "200"
                    message: "success"
                    traceId: "abc123"
                    errorMsgArray: []
                    data:
                      valid: true
                      errors: []
                invalid_result:
                  summary: 校验失败
                  value:
                    errcode: "200"
                    message: "success"
                    traceId: "abc123"
                    errorMsgArray: []
                    data:
                      valid: false
                      errors:
                        - field: "expression"
                          message: "Parse error at index 19: expected operand"
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result'

  /api/ai/rules/jexl/generate:
    post:
      tags:
        - AI规则生成
      summary: 生成JEXL规则
      description: |
        基于自然语言业务意图，使用大语言模型自动生成发票处理的JEXL规则。
        
        ## 规则类型
        - **1 (校验规则)**: 验证发票字段是否符合业务要求
        - **2 (补全规则)**: 自动补全缺失的发票字段值
        
        ## 生成类型
        - **FULL**: 生成完整规则（默认），包含fieldPath、applyTo、ruleExpression
        - **RULE_EXPRESSION_ONLY**: 仅生成规则表达式和fieldPath，适用于先确定核心逻辑
        - **APPLY_TO_ONLY**: 仅生成应用条件
        
        ## 生成流程
        1. 解析业务意图和上下文信息
        2. 根据generationType调用LLM生成对应部分的JEXL规则
        3. 本地语法校验和编译检查
        4. 如果校验失败，自动修复并重试
        5. 可选保存到数据库
        
        ## 示例场景
        - 校验：检查发票总金额是否大于0
        - 补全：根据供应商名称自动补全邮箱地址
      operationId: generateJexlRule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ruleType
                - businessIntent
              properties:
                ruleType:
                  type: integer
                  description: 规则类型
                  enum: [1, 2]
                  example: 1
                  x-enum-descriptions:
                    1: 校验规则 - 验证字段是否符合业务要求
                    2: 补全规则 - 自动补全缺失字段值
                fieldPath:
                  type: string
                  description: |
                    目标字段路径，可选。如果未提供，LLM会根据业务意图自动推断。
                    支持JSON路径格式，如：invoice.AccountingSupplierParty.Party.Contact.ElectronicMail
                  example: "invoice.LegalMonetaryTotal.TaxInclusiveAmount.value"
                businessIntent:
                  type: string
                  description: 自然语言描述的业务意图，必填
                  example: "检查发票总金额必须大于0"
                  minLength: 1
                  maxLength: 500
                country:
                  type: string
                  description: 国家二字码，可选，用于提供上下文
                  pattern: "^[A-Z]{2}$"
                  example: "CN"
                tags:
                  type: string
                  description: 行业标签，可选，用于提供业务上下文
                  example: "制造业,出口贸易"
                priority:
                  type: integer
                  description: 规则优先级，可选，默认为0
                  minimum: 0
                  maximum: 100
                  default: 0
                  example: 1
                invoiceSample:
                  type: object
                  description: |
                    样例发票数据，可选。提供给LLM作为参考，不进行执行级校验。
                    应符合UBL 2.1发票结构。
                  additionalProperties: true
                  example:
                    AccountingSupplierParty:
                      Party:
                        PartyName:
                          Name: "测试供应商有限公司"
                save:
                  type: boolean
                  description: 是否保存规则到数据库，可选，默认为false
                  default: false
                  example: false
                maxRetries:
                  type: integer
                  description: 语法校验失败时的最大重试次数，可选，默认为2
                  minimum: 0
                  maximum: 5
                  default: 2
                  example: 2
                generationType:
                  type: string
                  description: 生成类型，控制生成规则的范围，可选，默认为FULL
                  enum: [FULL, RULE_EXPRESSION_ONLY, APPLY_TO_ONLY]
                  default: FULL
                  example: FULL
                  x-enum-descriptions:
                    FULL: 生成完整规则，包含fieldPath、applyTo、ruleExpression
                    RULE_EXPRESSION_ONLY: 仅生成规则表达式和fieldPath，适用于先确定核心逻辑和目标字段
                    APPLY_TO_ONLY: 仅生成应用条件
            examples:
              validation_rule:
                summary: 校验规则示例
                description: 生成一个校验发票总金额的规则
                value:
                  ruleType: 1
                  businessIntent: "检查发票总金额必须大于0"
                  country: "CN"
                  tags: "制造业"
                  priority: 1
                  save: false
                  maxRetries: 2
              completion_rule:
                summary: 补全规则示例  
                description: 生成一个自动补全供应商邮箱的规则
                value:
                  ruleType: 2
                  fieldPath: "invoice.AccountingSupplierParty.Party.Contact.ElectronicMail"
                  businessIntent: "根据供应商名称自动补全邮箱地址"
                  country: "CN"
                  generationType: "FULL"
                  invoiceSample:
                    AccountingSupplierParty:
                      Party:
                        PartyName:
                          Name: "测试供应商有限公司"
                  save: true
                  maxRetries: 3
              rule_expression_only:
                summary: 仅生成规则表达式示例
                description: 先生成核心业务逻辑和字段路径，后续再补充触发条件
                value:
                  ruleType: 1
                  businessIntent: "检查发票总金额必须大于0且小于1000000"
                  country: "CN"
                  generationType: "RULE_EXPRESSION_ONLY"
                  save: false
              apply_to_only_with_fieldpath:
                summary: 基于指定字段生成应用条件示例
                description: 基于已知字段路径生成触发条件
                value:
                  ruleType: 1
                  fieldPath: "invoice.LegalMonetaryTotal.TaxInclusiveAmount.value"
                  businessIntent: "当发票总金额字段存在时执行校验"
                  country: "CN"
                  generationType: "APPLY_TO_ONLY"
                  save: false
              apply_to_only_inference:
                summary: AI推断字段生成应用条件示例
                description: 让AI根据业务意图推断相关字段并生成触发条件
                value:
                  ruleType: 1
                  businessIntent: "当发票包含增值税信息时执行校验"
                  country: "CN"
                  generationType: "APPLY_TO_ONLY"
                  save: false
      responses:
        '200':
          description: 规则生成成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Result'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          generatedRule:
                            $ref: '#/components/schemas/InvoiceRules'
                          saved:
                            type: boolean
                            description: 是否已保存到数据库
                            example: false
                          ruleId:
                            type: integer
                            format: int64
                            nullable: true
                            description: 保存成功时返回的规则ID
                            example: null
                          attempts:
                            type: array
                            description: 生成尝试记录，包括重试信息
                            items:
                              type: object
                              description: 生成尝试信息
                              properties:
                                index:
                                  type: integer
                                  description: 尝试次数序号，从1开始
                                  example: 1
                                syntaxOk:
                                  type: boolean
                                  description: 语法校验是否通过
                                  example: true
                                errorSummary:
                                  type: string
                                  nullable: true
                                  description: 语法错误摘要，校验通过时为null
                                  example: null
                                candidateJson:
                                  type: string
                                  description: LLM生成的原始JSON字符串
                                  example: "{\"ruleName\":\"发票总金额校验\",\"ruleType\":1,...}"
                            example:
                              - index: 1
                                syntaxOk: true
                                errorSummary: null
                                candidateJson: "{\"ruleName\":\"发票总金额校验\",...}"
              examples:
                success_example:
                  summary: 成功生成完整规则
                  value:
                    errcode: "200"
                    message: "success"
                    traceId: "abc123"
                    errorMsgArray: []
                    data:
                      generatedRule:
                        id: null
                        country: "CN"
                        tags: "制造业"
                        ruleType: 1
                        ruleName: "发票总金额校验"
                        fieldPath: "invoice.LegalMonetaryTotal.TaxInclusiveAmount.value"
                        applyTo: "invoice != null && invoice.LegalMonetaryTotal != null"
                        ruleExpression: "(invoice.LegalMonetaryTotal.TaxInclusiveAmount.value instanceof java.lang.Number && invoice.LegalMonetaryTotal.TaxInclusiveAmount.value.doubleValue() > 0)"
                        errorMessage: "发票总金额必须大于0"
                        priority: 1
                        active: true
                      saved: false
                      ruleId: null
                      attempts:
                        - index: 1
                          syntaxOk: true
                          errorSummary: null
                          candidateJson: "{\"ruleName\":\"发票总金额校验\",...}"
                rule_expression_only_example:
                  summary: 仅生成规则表达式结果
                  value:
                    errcode: "200"
                    message: "success"
                    traceId: "abc124"
                    errorMsgArray: []
                    data:
                      generatedRule:
                        id: null
                        country: "CN"
                        ruleType: 1
                        ruleName: "发票总金额范围校验"
                        fieldPath: "invoice.LegalMonetaryTotal.TaxInclusiveAmount.value"
                        applyTo: null
                        ruleExpression: "invoice.LegalMonetaryTotal.TaxInclusiveAmount.value != null && (invoice.LegalMonetaryTotal.TaxInclusiveAmount.value instanceof java.lang.Number && invoice.LegalMonetaryTotal.TaxInclusiveAmount.value.doubleValue() > 0 && invoice.LegalMonetaryTotal.TaxInclusiveAmount.value.doubleValue() < 1000000)"
                        errorMessage: "发票总金额必须大于0且小于1000000"
                        priority: 0
                        active: true
                      saved: false
                      ruleId: null
                      attempts:
                        - index: 1
                          syntaxOk: true
                          errorSummary: null
                          candidateJson: "{\"ruleName\":\"发票总金额范围校验\",...}"
                apply_to_only_with_fieldpath_example:
                  summary: 基于指定字段生成应用条件结果
                  value:
                    errcode: "200"
                    message: "success"
                    traceId: "abc125"
                    errorMsgArray: []
                    data:
                      generatedRule:
                        id: null
                        country: "CN"
                        ruleType: 1
                        ruleName: "发票总金额字段触发条件"
                        fieldPath: "invoice.LegalMonetaryTotal.TaxInclusiveAmount.value"
                        applyTo: "invoice != null && invoice.LegalMonetaryTotal != null && invoice.LegalMonetaryTotal.TaxInclusiveAmount != null"
                        ruleExpression: null
                        errorMessage: null
                        priority: 0
                        active: true
                      saved: false
                      ruleId: null
                      attempts:
                        - index: 1
                          syntaxOk: true
                          errorSummary: null
                          candidateJson: "{\"applyTo\":\"invoice != null && invoice.LegalMonetaryTotal != null\",...}"
                apply_to_only_inference_example:
                  summary: AI推断字段生成应用条件结果
                  value:
                    errcode: "200"
                    message: "success"
                    traceId: "abc126"
                    errorMsgArray: []
                    data:
                      generatedRule:
                        id: null
                        country: "CN"
                        ruleType: 1
                        ruleName: "增值税发票触发条件"
                        fieldPath: "invoice.TaxTotal"
                        applyTo: "invoice != null && invoice.TaxTotal != null && invoice.TaxTotal.size() > 0"
                        ruleExpression: null
                        errorMessage: null
                        priority: 0
                        active: true
                      saved: false
                      ruleId: null
                      attempts:
                        - index: 1
                          syntaxOk: true
                          errorSummary: null
                          candidateJson: "{\"fieldPath\":\"invoice.TaxTotal\",\"applyTo\":\"invoice != null && invoice.TaxTotal != null\",...}"
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result'
              examples:
                missing_business_intent:
                  summary: 缺少业务意图
                  value:
                    error: "参数错误"
                    message: "businessIntent字段不能为空"
                    timestamp: "2024-01-15T10:30:00Z"
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result'
              examples:
                llm_error:
                  summary: LLM调用失败
                  value:
                    error: "LLM调用失败"
                    message: "API密钥无效或网络连接问题"
                    timestamp: "2024-01-15T10:30:00Z"

components:
  schemas:
    # 复用现有的Result和InvoiceRules schema
    Result:
      type: object
      description: 统一响应结构（复用现有schema）
      properties:
        errcode:
          type: string
          description: 错误码
          example: "200"
        message:
          type: string
          description: 消息
          example: "success"
        traceId:
          type: string
          description: 跟踪ID（由系统自动注入）
          example: "abc123def456"
        errorMsgArray:
          type: array
          items:
            type: string
          description: 错误消息数组
          example: []
        noise:
          type: string
          description: 噪音
          example: null
        sign:
          type: string
          description: 签名
          example: null

    InvoiceRules:
      type: object
      description: 发票规则实体（复用现有schema）
      properties:
        id:
          type: integer
          format: int64
          description: 主键ID
        companyId:
          type: string
          description: 企业ID
        country:
          type: string
          description: 国家二字码
        tradeArea:
          type: string
          description: 贸易区
        province:
          type: string
          description: 省
        city:
          type: string
          description: 城市
        tags:
          type: string
          description: 行业
        invoiceType:
          type: string
          description: 发票类型
        ruleCode:
          type: string
          description: 规则唯一编码，三段式，洲-sys/user-流水号
        ruleName:
          type: string
          description: 规则名称
        ruleType:
          type: integer
          description: 规则类型：1校验，2补全
        active:
          type: boolean
          description: 是否启用
        status:
          type: integer
          description: 规则状态：1草稿 2测试通过 3已发布
        applyTo:
          type: string
          description: 规则应用条件
        errorMessage:
          type: string
          description: 错误提示信息
        fieldPath:
          type: string
          description: 字段路径
        priority:
          type: integer
          description: 优先级
        ruleExpression:
          type: string
          description: 规则表达式
        startTime:
          type: string
          format: date-time
          description: 规则生效开始时间
        endTime:
          type: string
          format: date-time
          description: 规则生效结束时间
        createTime:
          type: string
          format: date-time
          description: 创建时间
        updateTime:
          type: string
          format: date-time
          description: 更新时间

tags:
  - name: JEXL校验
    description: |
      JEXL语法校验功能，支持：
      - 表达式语法检查
      - 编译错误检测
      - 详细错误信息返回
  - name: AI规则生成
    description: |
      基于大语言模型的智能规则生成功能，支持：
      - 自然语言到JEXL规则的自动转换
      - 灵活的分步生成模式（完整/仅表达式/仅条件）
      - 语法校验和自动修复
      - 数据库函数集成
      - 规则持久化管理
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kingdee.fpy.mapper.InvoiceRulesMapper">

    <resultMap id="InvoiceRulesResultMap" type="com.kingdee.fpy.model.InvoiceRules">
        <id property="id" column="fid" />
        <result property="country" column="fcountry" />
        <result property="tradeArea" column="ftrade_area" />
        <result property="province" column="fprovince" />
        <result property="city" column="fcity" />
        <result property="tags" column="ftags" />
        <result property="invoiceType" column="finvoice_type" />
        <result property="subInvoiceType" column="fsub_invoice_type" />
        <result property="ruleCode" column="frule_code" />
        <result property="ruleName" column="frule_name" />
        <result property="ruleType" column="frule_type" />
        <result property="active" column="factive" />
        <result property="status" column="fstatus" />
        <result property="applyTo" column="fapply_to" />
        <result property="errorMessage" column="ferror_message" />
        <result property="fieldPath" column="ffield_path" />
        <result property="priority" column="fpriority" />
        <result property="ruleExpression" column="frule_expression" />
        <result property="description" column="fdescription" />
        <result property="ruleVersion" column="frule_version" />
        <result property="publishTime" column="fpublish_time" />
        <result property="startTime" column="fstart_time" />
        <result property="endTime" column="fend_time" />
        <result property="createTime" column="fcreate_time" />
        <result property="updateTime" column="fupdate_time" />
    </resultMap>

    <insert id="insert" parameterType="com.kingdee.fpy.model.InvoiceRules" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_invoice_rules 
        (fcountry, ftrade_area, fprovince, fcity, ftags, finvoice_type, fsub_invoice_type, frule_code, frule_name, frule_type, factive, fstatus, fapply_to, ferror_message, ffield_path, fpriority, frule_expression, fdescription, frule_version, fpublish_time, fstart_time, fend_time)
        VALUES
        (#{country}, #{tradeArea}, #{province}, #{city}, #{tags}, #{invoiceType}, #{subInvoiceType}, #{ruleCode}, #{ruleName}, #{ruleType}, #{active}, #{status}, #{applyTo}, #{errorMessage}, #{fieldPath}, #{priority}, #{ruleExpression}, #{description}, #{ruleVersion}, #{publishTime}, #{startTime}, #{endTime})
    </insert>

    <update id="updateById" parameterType="com.kingdee.fpy.model.InvoiceRules">
        UPDATE t_invoice_rules
        <set>
            <if test="country != null">fcountry = #{country},</if>
            <if test="tradeArea != null">ftrade_area = #{tradeArea},</if>
            <if test="province != null">fprovince = #{province},</if>
            <if test="city != null">fcity = #{city},</if>
            <if test="tags != null">ftags = #{tags},</if>
            <if test="invoiceType != null">finvoice_type = #{invoiceType},</if>
            <if test="subInvoiceType != null">fsub_invoice_type = #{subInvoiceType},</if>
            <if test="ruleCode != null">frule_code = #{ruleCode},</if>
            <if test="ruleName != null">frule_name = #{ruleName},</if>
            <if test="ruleType != null">frule_type = #{ruleType},</if>
            <if test="active != null">factive = #{active},</if>
            <if test="status != null">fstatus = #{status},</if>
            <if test="applyTo != null">fapply_to = #{applyTo},</if>
            <if test="errorMessage != null">ferror_message = #{errorMessage},</if>
            <if test="fieldPath != null">ffield_path = #{fieldPath},</if>
            <if test="priority != null">fpriority = #{priority},</if>
            <if test="ruleExpression != null">frule_expression = #{ruleExpression},</if>
            <if test="description != null">fdescription = #{description},</if>
            <if test="ruleVersion != null">frule_version = #{ruleVersion},</if>
            <if test="publishTime != null">fpublish_time = #{publishTime},</if>
            <if test="startTime != null">fstart_time = #{startTime},</if>
            <if test="endTime != null">fend_time = #{endTime},</if>
        </set>
        WHERE fid = #{id}
    </update>

    <delete id="deleteById" parameterType="long">
        DELETE FROM t_invoice_rules WHERE fid = #{id}
    </delete>

    <select id="selectById" parameterType="long" resultMap="InvoiceRulesResultMap">
        SELECT fid, fcountry, ftrade_area, fprovince, fcity, ftags, finvoice_type, fsub_invoice_type, frule_code, frule_name, frule_type, factive, fstatus, fapply_to, ferror_message, ffield_path, fpriority, frule_expression, fdescription, frule_version, fpublish_time, fstart_time, fend_time, fcreate_time, fupdate_time
        FROM t_invoice_rules 
        WHERE fid = #{id}
    </select>

    <select id="selectAll" resultMap="InvoiceRulesResultMap">
        SELECT fid, fcountry, ftrade_area, fprovince, fcity, ftags, finvoice_type, fsub_invoice_type, frule_code, frule_name, frule_type, factive, fstatus, fapply_to, ferror_message, ffield_path, fpriority, frule_expression, fdescription, frule_version, fpublish_time, fstart_time, fend_time, fcreate_time, fupdate_time
        FROM t_invoice_rules
    </select>

    <select id="selectByTenantIdOrCompanyId" resultMap="InvoiceRulesResultMap">
        SELECT r.fid, r.fcountry, r.ftrade_area, r.fprovince, r.fcity, r.ftags, r.finvoice_type, r.fsub_invoice_type, r.frule_code, r.frule_name, r.frule_type,
        r.factive, r.fstatus, r.fapply_to, r.ferror_message, r.ffield_path, r.fpriority, r.frule_expression, r.fdescription, r.frule_version, r.fpublish_time, r.fstart_time, r.fend_time, r.fcreate_time, r.fupdate_time
        FROM t_invoice_rules r
        left join t_rule_subscription s on s.frule_code = r.frule_code
        WHERE
        fcountry = #{country}
        <if test="tenantId != null and tenantId != ''">
            ftenant_id = #{tenantId}
        </if>
        <if test="companyId != null and companyId != ''">
            OR fcompany_id = #{companyId}
        </if>
        and fstart_time <![CDATA[ <= ]]> now()
        and fend_time <![CDATA[ >= ]]> now()
        order by fpriority asc
    </select>

    <select id="selectByCompanyIdAndRuleCode" resultMap="InvoiceRulesResultMap">
        SELECT fid, fcountry, ftrade_area, fprovince, fcity, ftags, finvoice_type, fsub_invoice_type, frule_code, frule_name, frule_type, factive, fstatus, fapply_to, ferror_message, ffield_path, fpriority, frule_expression, fdescription, frule_version, fpublish_time, fstart_time, fend_time, fcreate_time, fupdate_time
        FROM t_invoice_rules 
        WHERE 1=1
        <if test="ruleCode != null and ruleCode != ''">
            AND frule_code = #{ruleCode}
        </if>
        AND fstart_time <![CDATA[ <= ]]> now()
        AND fend_time <![CDATA[ >= ]]> now()
        ORDER BY fpriority ASC
    </select>
    
    <select id="selectMaxSequenceByCountryAndType" resultType="java.lang.Integer">
        SELECT MAX(CAST(SUBSTRING(frule_code, LENGTH('custom-' + #{country} + '-' + #{invoiceType} + '-') + 1) AS UNSIGNED)) as max_seq
        FROM t_invoice_rules 
        WHERE frule_code LIKE CONCAT('custom-', #{country}, '-', #{invoiceType}, '-%')
        and fcountry = #{country}
    </select>

    <update id="updateStatus">
        UPDATE t_invoice_rules 
        SET fstatus = #{status}
        WHERE frule_code = #{ruleCode}
    </update>

    <update id="updateStatusVersionAndPublishTime">
        UPDATE t_invoice_rules 
        SET fstatus = #{status},
            frule_version = #{version},
            fpublish_time = #{publishTime}
        WHERE frule_code = #{ruleCode}
    </update>

    <select id="selectSubscribedRulesByCompanyId" parameterType="com.kingdee.fpy.model.InvoiceRules" resultMap="InvoiceRulesResultMap">
        SELECT DISTINCT r.fid, r.fcountry, r.ftrade_area, r.fprovince, r.fcity, r.ftags, r.finvoice_type, r.fsub_invoice_type, 
               r.frule_code, r.frule_name, r.frule_type, r.factive, r.fstatus, r.fapply_to, r.ferror_message, 
               r.ffield_path, r.fpriority, r.frule_expression, r.fdescription, r.frule_version, r.fpublish_time, r.fstart_time, r.fend_time, r.fcreate_time, r.fupdate_time
        FROM t_invoice_rules r
        LEFT JOIN t_rule_subscription s ON s.frule_code = r.frule_code
        WHERE
        r.fcountry = #{country}
          AND (
            <!-- 系统预制规则：ruleCode以'sys-'开头 -->
            r.frule_code LIKE 'sys-%'
            OR
            <!-- 企业订阅的规则：通过订阅表关联 -->
            s.fcompany_id = #{companyId}
          )
        ORDER BY r.fpriority ASC, r.fcreate_time DESC
    </select>

    <select id="selectRuleStatusStatistics" resultType="com.kingdee.fpy.dto.RuleStatusStatisticsDto">
        SELECT 
            CASE fstatus
                WHEN 1 THEN 'Draft'
                WHEN 2 THEN 'TestPassed' 
                WHEN 3 THEN 'Published'
                WHEN 4 THEN 'Enabled'
                WHEN 5 THEN 'Disabled'
                ELSE 'Unknown'
            END as statusKey,
            CASE fstatus
                WHEN 1 THEN '草稿'
                WHEN 2 THEN '测试通过' 
                WHEN 3 THEN '已发布'
                WHEN 4 THEN '启用'
                WHEN 5 THEN '停用'
                ELSE '未知'
            END as statusName,
            COUNT(*) as count
        FROM t_invoice_rules 
        WHERE fstatus IS NOT NULL
        GROUP BY fstatus
        ORDER BY fstatus
    </select>

    <select id="selectRuleMonthlyPublishData" resultType="com.kingdee.fpy.dto.RuleMonthlyPublishDataDto">
        SELECT 
            frule_type as ruleType,
            DATE_FORMAT(fpublish_time, '%Y-%m') as publishMonth,
            COUNT(*) as count
        FROM t_invoice_rules 
        WHERE fstatus = 3 
        AND fpublish_time IS NOT NULL
        GROUP BY frule_type, DATE_FORMAT(fpublish_time, '%Y-%m')
        ORDER BY frule_type, publishMonth
    </select>

    <select id="selectRulesByPage" parameterType="com.kingdee.fpy.model.InvoiceRulesQuery" resultMap="InvoiceRulesResultMap">
        SELECT fid, fcountry, ftrade_area, fprovince, fcity, ftags, finvoice_type, fsub_invoice_type, 
               frule_code, frule_name, frule_type, factive, fstatus, fapply_to, ferror_message, 
               ffield_path, fpriority, frule_expression, fdescription, frule_version, fpublish_time, 
               fstart_time, fend_time, fcreate_time, fupdate_time
        FROM t_invoice_rules
        <where>
            <if test="ruleType != null">
                AND frule_type = #{ruleType}
            </if>
            <if test="status != null">
                AND fstatus = #{status}
            </if>
            <if test="ruleCode != null and ruleCode != ''">
                AND frule_code LIKE CONCAT('%', #{ruleCode}, '%')
            </if>
        </where>
        ORDER BY fcreate_time DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="countRulesByQuery" parameterType="com.kingdee.fpy.model.InvoiceRulesQuery" resultType="int">
        SELECT COUNT(*)
        FROM t_invoice_rules
        <where>
            <if test="ruleType != null">
                AND frule_type = #{ruleType}
            </if>
            <if test="status != null">
                AND fstatus = #{status}
            </if>
            <if test="ruleCode != null and ruleCode != ''">
                AND frule_code LIKE CONCAT('%', #{ruleCode}, '%')
            </if>
        </where>
    </select>

</mapper>